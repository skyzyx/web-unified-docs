// Google Search Console → Google Sheets report
// Creates 3 tabs: Report (per URL), Sections (rollup), Goals (baselines + editable targets)
// Date ranges: last 90 days vs previous 90 days (ending yesterday)
// Search type: Web
//
// Prereq:
// 1) In Google Sheets, create a tab named "URLs" with full URLs in column A starting at A2.
// 2) In Apps Script: Services → + → enable "Search Console API".
//
// Run:
// - runGscSeoReport()
// - applyRecommendedGoals() (optional)

const SITE_URL = "https://developer.hashicorp.com/";
const SEARCH_TYPE = "web"; // web|image|video|news|discover|googleNews
const DAYS = 90;

function runGscSeoReport() {
  const ss = SpreadsheetApp.getActive();
  const urlsSheet = ss.getSheetByName("URLs");
  if (!urlsSheet) throw new Error('Missing sheet "URLs". Put URLs in A2:A');

  const urls = urlsSheet
    .getRange(2, 1, Math.max(urlsSheet.getLastRow() - 1, 0), 1)
    .getValues()
    .flat()
    .map(String)
    .map(s => s.trim())
    .filter(Boolean);

  if (urls.length === 0) throw new Error('No URLs found in "URLs" sheet (starting at A2).');

  const { current, previous } = buildDateRanges_(DAYS);

  // Per-URL results
  const urlRows = [];

  // Section rollups (weighted avg position by impressions)
  const sectionAgg = new Map(); // key -> {cur:{clicks,impr,posImpr}, prev:{...}}

  for (const pageUrl of urls) {
    const cur = queryPage_(pageUrl, current.start, current.end);
    const prev = queryPage_(pageUrl, previous.start, previous.end);

    const curCtr = safeCtr_(cur.clicks, cur.impressions);
    const prevCtr = safeCtr_(prev.clicks, prev.impressions);

    urlRows.push([
      pageUrl,
      sectionKey_(pageUrl),

      cur.clicks,
      prev.clicks,
      cur.clicks - prev.clicks,
      safePctChange_(cur.clicks, prev.clicks),

      cur.impressions,
      prev.impressions,
      cur.impressions - prev.impressions,
      safePctChange_(cur.impressions, prev.impressions),

      curCtr,
      prevCtr,
      curCtr - prevCtr,

      cur.position,
      prev.position,
      cur.position - prev.position, // negative delta is improvement (lower is better)

      current.start,
      current.end,
      previous.start,
      previous.end,
    ]);

    const key = sectionKey_(pageUrl);
    if (!sectionAgg.has(key)) sectionAgg.set(key, emptyAgg_());

    const agg = sectionAgg.get(key);
    agg.cur.clicks += cur.clicks;
    agg.cur.impr += cur.impressions;
    agg.cur.posImpr += (cur.position * cur.impressions);

    agg.prev.clicks += prev.clicks;
    agg.prev.impr += prev.impressions;
    agg.prev.posImpr += (prev.position * prev.impressions);
  }

  writeUrlReport_(ss, urlRows, current, previous);
  writeSectionReport_(ss, sectionAgg, current, previous);
  writeGoalsSheet_(ss, urlRows, current); // baselines from last 90d
}

function applyRecommendedGoals() {
  // Fills goal columns only when blank; preserves any manual overrides.
  // Recommendation:
  // - If baseline clicks < 100 (last 90d): clicks +50 to +100; impressions +20%; CTR +0.4pp; position improve ~1.25
  // - Else: clicks +15%; impressions +15%; CTR +0.3pp; position improve ~1.0

  const ss = SpreadsheetApp.getActive();
  const sheet = ss.getSheetByName("Goals");
  if (!sheet) throw new Error('Missing sheet "Goals". Run runGscSeoReport() first.');

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return;

  // Columns (1-indexed):
  // C: baseline clicks, D: baseline impressions, E: baseline CTR, F: baseline avg position
  // G: goal clicks, H: goal impressions, I: goal CTR, J: goal avg position
  const range = sheet.getRange(2, 1, lastRow - 1, 13); // A:M
  const values = range.getValues();

  for (let i = 0; i < values.length; i++) {
    const row = values[i];

    const baseClicks = Number(row[2]) || 0; // C
    const baseImpr = Number(row[3]) || 0;   // D
    const baseCtr = Number(row[4]) || 0;    // E (decimal)
    const basePos = Number(row[5]) || 0;    // F

    const goalClicksCell = row[6]; // G
    const goalImprCell = row[7];   // H
    const goalCtrCell = row[8];    // I
    const goalPosCell = row[9];    // J

    const lowVolume = baseClicks < 100;

    const clickTarget = lowVolume
      ? baseClicks + clamp_(Math.round(Math.max(50, Math.min(100, baseClicks * 0.75))), 50, 100)
      : Math.round(baseClicks * 1.15);

    const imprTarget = lowVolume
      ? Math.round(baseImpr * 1.20)
      : Math.round(baseImpr * 1.15);

    const ctrDelta = lowVolume ? 0.004 : 0.003; // 0.4pp or 0.3pp
    const ctrTarget = Math.max(0, baseCtr + ctrDelta);

    const posImprove = lowVolume ? 1.25 : 1.0;
    const posTarget = basePos > 0 ? Math.max(1, basePos - posImprove) : "";

    if (goalClicksCell === "" || goalClicksCell === null) row[6] = clickTarget;
    if (goalImprCell === "" || goalImprCell === null) row[7] = imprTarget;
    if (goalCtrCell === "" || goalCtrCell === null) row[8] = ctrTarget;
    if ((goalPosCell === "" || goalPosCell === null) && posTarget !== "") row[9] = posTarget;

    values[i] = row;
  }

  range.setValues(values);
}

function writeUrlReport_(ss, rows, current, previous) {
  const sheet = getOrCreateSheet_(ss, "Report");
  sheet.clearContents();

  sheet.getRange(1, 1, 1, 20).setValues([[
    "URL",
    "Section",
    "Clicks (last 90d)",
    "Clicks (prev 90d)",
    "Clicks Δ",
    "Clicks %Δ",
    "Impr (last 90d)",
    "Impr (prev 90d)",
    "Impr Δ",
    "Impr %Δ",
    "CTR (last 90d)",
    "CTR (prev 90d)",
    "CTR Δ",
    "Avg pos (last 90d)",
    "Avg pos (prev 90d)",
    "Avg pos Δ",
    "Start (last)",
    "End (last)",
    "Start (prev)",
    "End (prev)",
  ]]);

  sheet.getRange(2, 1, rows.length, rows[0].length).setValues(rows);
  sheet.setFrozenRows(1);

  sheet.getRange("F:F").setNumberFormat("0.00%");
  sheet.getRange("J:J").setNumberFormat("0.00%");
  sheet.getRange("K:M").setNumberFormat("0.00%");
  sheet.getRange("N:P").setNumberFormat("0.00");
}

function writeSectionReport_(ss, sectionAgg, current, previous) {
  const sheet = getOrCreateSheet_(ss, "Sections");
  sheet.clearContents();

  const rows = [];
  const keys = Array.from(sectionAgg.keys()).sort();

  for (const key of keys) {
    const agg = sectionAgg.get(key);

    const curClicks = agg.cur.clicks;
    const prevClicks = agg.prev.clicks;

    const curImpr = agg.cur.impr;
    const prevImpr = agg.prev.impr;

    const curCtr = safeCtr_(curClicks, curImpr);
    const prevCtr = safeCtr_(prevClicks, prevImpr);

    const curPos = curImpr > 0 ? (agg.cur.posImpr / curImpr) : 0;
    const prevPos = prevImpr > 0 ? (agg.prev.posImpr / prevImpr) : 0;

    rows.push([
      key,
      curClicks,
      prevClicks,
      curClicks - prevClicks,
      safePctChange_(curClicks, prevClicks),
      curImpr,
      prevImpr,
      curImpr - prevImpr,
      safePctChange_(curImpr, prevImpr),
      curCtr,
      prevCtr,
      curCtr - prevCtr,
      curPos,
      prevPos,
      curPos - prevPos,
      current.start,
      current.end,
      previous.start,
      previous.end,
    ]);
  }

  sheet.getRange(1, 1, 1, 19).setValues([[
    "Section",
    "Clicks (last 90d)",
    "Clicks (prev 90d)",
    "Clicks Δ",
    "Clicks %Δ",
    "Impr (last 90d)",
    "Impr (prev 90d)",
    "Impr Δ",
    "Impr %Δ",
    "CTR (last 90d)",
    "CTR (prev 90d)",
    "CTR Δ",
    "Avg pos (last 90d)",
    "Avg pos (prev 90d)",
    "Avg pos Δ",
    "Start (last)",
    "End (last)",
    "Start (prev)",
    "End (prev)",
  ]]);

  if (rows.length) sheet.getRange(2, 1, rows.length, rows[0].length).setValues(rows);
  sheet.setFrozenRows(1);

  sheet.getRange("E:E").setNumberFormat("0.00%");
  sheet.getRange("I:I").setNumberFormat("0.00%");
  sheet.getRange("J:L").setNumberFormat("0.00%");
  sheet.getRange("M:O").setNumberFormat("0.00");
}

function writeGoalsSheet_(ss, urlRows, currentRange) {
  const sheet = getOrCreateSheet_(ss, "Goals");

  const headers = [
    "URL",
    "Section",
    "Baseline clicks (last 90d)",
    "Baseline impressions (last 90d)",
    "Baseline CTR (last 90d)",
    "Baseline avg position (last 90d)",
    "Goal clicks (next period)",
    "Goal impressions (next period)",
    "Goal CTR (next period)",
    "Goal avg position (next period)",
    "Notes",
    "Baseline start",
    "Baseline end",
  ];

  // Preserve existing goals/notes keyed by URL
  const existing = sheet.getDataRange().getValues();
  const existingMap = new Map();
  if (existing.length > 1) {
    for (let i = 1; i < existing.length; i++) {
      const row = existing[i];
      const url = row[0];
      if (url) {
        existingMap.set(String(url), {
          goalClicks: row[6],
          goalImpr: row[7],
          goalCtr: row[8],
          goalPos: row[9],
          notes: row[10],
        });
      }
    }
  }

  sheet.clearContents();
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);

  const rows = urlRows.map(r => {
    const url = r[0];
    const section = r[1];

    const baseClicks = r[2];
    const baseImpr = r[6];
    const baseCtr = r[10];
    const basePos = r[13];

    const preserved = existingMap.get(url) || {};
    return [
      url,
      section,
      baseClicks,
      baseImpr,
      baseCtr,
      basePos,
      preserved.goalClicks ?? "",
      preserved.goalImpr ?? "",
      preserved.goalCtr ?? "",
      preserved.goalPos ?? "",
      preserved.notes ?? "",
      currentRange.start,
      currentRange.end,
    ];
  });

  sheet.getRange(2, 1, rows.length, rows[0].length).setValues(rows);
  sheet.setFrozenRows(1);

  sheet.getRange("E:E").setNumberFormat("0.00%");
  sheet.getRange("I:I").setNumberFormat("0.00%");
  sheet.getRange("F:F").setNumberFormat("0.00");
  sheet.getRange("J:J").setNumberFormat("0.00");
}

function queryPage_(pageUrl, startDate, endDate) {
  const request = {
    startDate,
    endDate,
    dimensions: ["page"],
    searchType: SEARCH_TYPE,
    rowLimit: 1,
    dimensionFilterGroups: [{
      filters: [{
        dimension: "page",
        operator: "equals",
        expression: pageUrl,
      }],
    }],
  };

  const resp = SearchConsole.Searchanalytics.query(request, SITE_URL);
  const row = (resp && resp.rows && resp.rows[0]) ? resp.rows[0] : null;

  return {
    clicks: row ? Number(row.clicks) : 0,
    impressions: row ? Number(row.impressions) : 0,
    position: row ? Number(row.position) : 0,
  };
}

function buildDateRanges_(days) {
  // Use yesterday as end date to avoid partial data for today.
  const end = new Date();
  end.setDate(end.getDate() - 1);

  const currentStart = new Date(end);
  currentStart.setDate(currentStart.getDate() - (days - 1));

  const prevEnd = new Date(currentStart);
  prevEnd.setDate(prevEnd.getDate() - 1);

  const prevStart = new Date(prevEnd);
  prevStart.setDate(prevStart.getDate() - (days - 1));

  return {
    current: { start: fmt_(currentStart), end: fmt_(end) },
    previous: { start: fmt_(prevStart), end: fmt_(prevEnd) },
  };
}

function sectionKey_(fullUrl) {
  // Groups by: /well-architected-framework/{pillar}/{category}
  // Example: https://developer.../well-architected-framework/secure-systems/secrets/rotate-secrets
  try {
    const u = new URL(fullUrl);
    const parts = u.pathname.split("/").filter(Boolean);
    if (parts.length >= 3 && parts[0] === "well-architected-framework") {
      return `/${parts[0]}/${parts[1]}/${parts[2]}`;
    }
    return `/${parts.slice(0, 3).join("/")}`;
  } catch (e) {
    return "unknown";
  }
}

function emptyAgg_() {
  return {
    cur: { clicks: 0, impr: 0, posImpr: 0 },
    prev: { clicks: 0, impr: 0, posImpr: 0 },
  };
}

function safeCtr_(clicks, impressions) {
  return impressions > 0 ? (clicks / impressions) : 0;
}

function safePctChange_(current, previous) {
  if (previous === 0) return current === 0 ? 0 : 1;
  return (current - previous) / previous;
}

function fmt_(d) {
  return Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy-MM-dd");
}

function getOrCreateSheet_(ss, name) {
  return ss.getSheetByName(name) || ss.insertSheet(name);
}

function clamp_(n, min, max) {
  return Math.max(min, Math.min(max, n));
}
